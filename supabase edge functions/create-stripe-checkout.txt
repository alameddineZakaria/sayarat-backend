import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type'
};

// Product configurations
const PRODUCTS: Record<string, { name: string; price: number; mode: 'payment' | 'subscription'; recurring?: { interval: 'month' | 'year' } }> = {
  'com.sayarat.subscription.basic.monthly': {
    name: 'Dealer Basic - Monthly',
    price: 2999, // in cents
    mode: 'subscription',
    recurring: { interval: 'month' }
  },
  'com.sayarat.subscription.pro.monthly': {
    name: 'Dealer Pro - Monthly',
    price: 7999,
    mode: 'subscription',
    recurring: { interval: 'month' }
  },
  'com.sayarat.subscription.premium.monthly': {
    name: 'Dealer Premium - Monthly',
    price: 14999,
    mode: 'subscription',
    recurring: { interval: 'month' }
  },
  'com.sayarat.vehicle_history_report': {
    name: 'Vehicle History Report',
    price: 1000,
    mode: 'payment'
  },
  'com.sayarat.boost.1day': {
    name: '1-Day Listing Boost',
    price: 500,
    mode: 'payment'
  },
  'com.sayarat.boost.3days': {
    name: '3-Day Listing Boost',
    price: 1200,
    mode: 'payment'
  },
  'com.sayarat.boost.7days': {
    name: '7-Day Listing Boost',
    price: 2500,
    mode: 'payment'
  },
};

Deno.serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const stripeApiKey = Deno.env.get('GATEWAY_API_KEY');
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    if (!stripeApiKey) {
      return new Response(JSON.stringify({ error: 'Stripe API key not configured' }), {
        status: 500,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    // Get authorization header
    const authHeader = req.headers.get('Authorization');
    if (!authHeader) {
      return new Response(JSON.stringify({ error: 'No authorization header' }), {
        status: 401,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    // Verify the user
    const { data: { user }, error: authError } = await supabase.auth.getUser(
      authHeader.replace('Bearer ', '')
    );

    if (authError || !user) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), {
        status: 401,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    const body = await req.json();
    const { action, product_id, listing_id, vin, success_url, cancel_url, subscription_id, pause_duration } = body;

    // Handle different actions
    if (action === 'cancel_subscription') {
      return await handleCancelSubscription(stripeApiKey, subscription_id, supabase, user.id);
    }

    if (action === 'create_portal_session') {
      return await handleCreatePortalSession(stripeApiKey, supabase, user.id, body.return_url);
    }

    if (action === 'pause_subscription') {
      return await handlePauseSubscription(stripeApiKey, subscription_id, pause_duration, supabase, user.id);
    }

    if (action === 'resume_subscription') {
      return await handleResumeSubscription(stripeApiKey, subscription_id, supabase, user.id);
    }

    // Default action: create checkout session
    if (!product_id) {
      return new Response(JSON.stringify({ error: 'product_id is required' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    const product = PRODUCTS[product_id];
    if (!product) {
      return new Response(JSON.stringify({ error: 'Invalid product_id' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    // Get or create Stripe customer
    let customerId: string | null = null;
    
    // Check if user already has a Stripe customer ID
    const { data: subscription } = await supabase
      .from('subscriptions')
      .select('stripe_customer_id')
      .eq('user_id', user.id)
      .single();

    if (subscription?.stripe_customer_id) {
      customerId = subscription.stripe_customer_id;
    } else {
      // Create a new Stripe customer
      const customerResponse = await fetch('https://api.stripe.com/v1/customers', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${stripeApiKey}`,
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          email: user.email || '',
          'metadata[user_id]': user.id,
        }).toString()
      });

      if (customerResponse.ok) {
        const customer = await customerResponse.json();
        customerId = customer.id;
      }
    }

    // Build line items
    const lineItems: any = {
      'line_items[0][price_data][currency]': 'usd',
      'line_items[0][price_data][product_data][name]': product.name,
      'line_items[0][price_data][unit_amount]': product.price.toString(),
      'line_items[0][quantity]': '1',
    };

    if (product.mode === 'subscription' && product.recurring) {
      lineItems['line_items[0][price_data][recurring][interval]'] = product.recurring.interval;
    }

    // Build checkout session params
    const params: Record<string, string> = {
      ...lineItems,
      mode: product.mode,
      success_url: success_url || `${supabaseUrl.replace('/rest/v1', '')}/purchase-success?session_id={CHECKOUT_SESSION_ID}&product=${product_id}`,
      cancel_url: cancel_url || `${supabaseUrl.replace('/rest/v1', '')}/purchase-cancelled`,
      'metadata[product_id]': product_id,
      'metadata[user_id]': user.id,
    };

    if (customerId) {
      params.customer = customerId;
    } else {
      params.customer_email = user.email || '';
    }

    // Add product-specific metadata
    if (listing_id) {
      params['metadata[listing_id]'] = listing_id;
    }
    if (vin) {
      params['metadata[vin]'] = vin;
    }

    // Allow subscription pause for subscription products
    if (product.mode === 'subscription') {
      params['subscription_data[metadata][user_id]'] = user.id;
      params['subscription_data[metadata][product_id]'] = product_id;
    }

    // Create checkout session
    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${stripeApiKey}`,
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams(params).toString()
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('Stripe error:', errorData);
      return new Response(JSON.stringify({ error: errorData.error?.message || 'Failed to create checkout session' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    const session = await response.json();

    return new Response(JSON.stringify({
      sessionId: session.id,
      url: session.url
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });

  } catch (error: any) {
    console.error('Checkout error:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });
  }
});

// Handle subscription cancellation
async function handleCancelSubscription(stripeApiKey: string, subscriptionId: string, supabase: any, userId: string) {
  if (!subscriptionId) {
    // Get subscription ID from database
    const { data: sub } = await supabase
      .from('subscriptions')
      .select('platform_subscription_id')
      .eq('user_id', userId)
      .eq('platform', 'stripe')
      .single();

    if (!sub?.platform_subscription_id) {
      return new Response(JSON.stringify({ error: 'No active subscription found' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }
    subscriptionId = sub.platform_subscription_id;
  }

  // Cancel at period end
  const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${stripeApiKey}`,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      cancel_at_period_end: 'true'
    }).toString()
  });

  if (!response.ok) {
    const errorData = await response.json();
    return new Response(JSON.stringify({ error: errorData.error?.message || 'Failed to cancel subscription' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });
  }

  const subscription = await response.json();

  // Update local database
  await supabase
    .from('subscriptions')
    .update({
      status: 'cancelling',
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId);

  return new Response(JSON.stringify({
    success: true,
    cancel_at: subscription.cancel_at ? new Date(subscription.cancel_at * 1000).toISOString() : null,
    current_period_end: subscription.current_period_end ? new Date(subscription.current_period_end * 1000).toISOString() : null
  }), {
    status: 200,
    headers: { 'Content-Type': 'application/json', ...corsHeaders }
  });
}

// Handle pause subscription
async function handlePauseSubscription(stripeApiKey: string, subscriptionId: string, pauseDuration: number, supabase: any, userId: string) {
  if (!subscriptionId) {
    const { data: sub } = await supabase
      .from('subscriptions')
      .select('platform_subscription_id')
      .eq('user_id', userId)
      .eq('platform', 'stripe')
      .single();

    if (!sub?.platform_subscription_id) {
      return new Response(JSON.stringify({ error: 'No active subscription found' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }
    subscriptionId = sub.platform_subscription_id;
  }

  // Calculate resume date (max 3 months)
  const maxPauseDays = 90;
  const pauseDays = Math.min(pauseDuration || 30, maxPauseDays);
  const resumeDate = Math.floor(Date.now() / 1000) + (pauseDays * 24 * 60 * 60);

  // Pause the subscription
  const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${stripeApiKey}`,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      'pause_collection[behavior]': 'void',
      'pause_collection[resumes_at]': resumeDate.toString()
    }).toString()
  });

  if (!response.ok) {
    const errorData = await response.json();
    return new Response(JSON.stringify({ error: errorData.error?.message || 'Failed to pause subscription' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });
  }

  const subscription = await response.json();
  const resumeAt = new Date(resumeDate * 1000).toISOString();

  // Update local database
  await supabase
    .from('subscriptions')
    .update({
      status: 'paused',
      paused_at: new Date().toISOString(),
      resume_at: resumeAt,
      pause_reason: `Paused for ${pauseDays} days`,
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId);

  // Update user profile
  await supabase
    .from('profiles')
    .update({
      subscription_status: 'paused'
    })
    .eq('id', userId);

  return new Response(JSON.stringify({
    success: true,
    paused: true,
    resume_at: resumeAt,
    pause_days: pauseDays
  }), {
    status: 200,
    headers: { 'Content-Type': 'application/json', ...corsHeaders }
  });
}

// Handle resume subscription
async function handleResumeSubscription(stripeApiKey: string, subscriptionId: string, supabase: any, userId: string) {
  if (!subscriptionId) {
    const { data: sub } = await supabase
      .from('subscriptions')
      .select('platform_subscription_id')
      .eq('user_id', userId)
      .eq('platform', 'stripe')
      .single();

    if (!sub?.platform_subscription_id) {
      return new Response(JSON.stringify({ error: 'No subscription found' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }
    subscriptionId = sub.platform_subscription_id;
  }

  // Resume the subscription by removing pause_collection
  const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${stripeApiKey}`,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      'pause_collection': ''
    }).toString()
  });

  if (!response.ok) {
    const errorData = await response.json();
    return new Response(JSON.stringify({ error: errorData.error?.message || 'Failed to resume subscription' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });
  }

  const subscription = await response.json();

  // Update local database
  await supabase
    .from('subscriptions')
    .update({
      status: 'active',
      paused_at: null,
      resume_at: null,
      pause_reason: null,
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId);

  // Update user profile
  await supabase
    .from('profiles')
    .update({
      subscription_status: 'active'
    })
    .eq('id', userId);

  return new Response(JSON.stringify({
    success: true,
    resumed: true,
    status: 'active'
  }), {
    status: 200,
    headers: { 'Content-Type': 'application/json', ...corsHeaders }
  });
}

// Handle creating customer portal session
async function handleCreatePortalSession(stripeApiKey: string, supabase: any, userId: string, returnUrl: string) {
  // Get customer ID
  const { data: sub } = await supabase
    .from('subscriptions')
    .select('stripe_customer_id')
    .eq('user_id', userId)
    .eq('platform', 'stripe')
    .single();

  if (!sub?.stripe_customer_id) {
    return new Response(JSON.stringify({ error: 'No Stripe customer found' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });
  }

  const response = await fetch('https://api.stripe.com/v1/billing_portal/sessions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${stripeApiKey}`,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      customer: sub.stripe_customer_id,
      return_url: returnUrl || 'https://sayarat.com/subscription'
    }).toString()
  });

  if (!response.ok) {
    const errorData = await response.json();
    return new Response(JSON.stringify({ error: errorData.error?.message || 'Failed to create portal session' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });
  }

  const session = await response.json();

  return new Response(JSON.stringify({
    url: session.url
  }), {
    status: 200,
    headers: { 'Content-Type': 'application/json', ...corsHeaders }
  });
}