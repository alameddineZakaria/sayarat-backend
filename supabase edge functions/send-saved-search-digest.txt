
export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type'
};

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

interface SavedSearch {
  id: string;
  user_id: string;
  name: string;
  search_query: string | null;
  filters: {
    make?: string;
    bodyType?: string;
    priceRange?: string;
    location?: string;
    condition?: string;
    transmission?: string;
    fuelType?: string;
    minPrice?: string;
    maxPrice?: string;
    minYear?: string;
    maxYear?: string;
    distance?: number;
    color?: string;
  };
  email_digest_enabled: boolean;
  last_digest_sent_at: string | null;
}

interface Vehicle {
  id: string;
  title: string;
  make: string;
  model: string;
  year: number;
  price: number;
  body_type: string;
  location: string;
  condition: string;
  transmission: string;
  fuel_type: string;
  images: string[];
  created_at: string;
  specs?: {
    color?: string;
  };
}

interface User {
  id: string;
  email: string;
  full_name?: string;
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const sendgridApiKey = Deno.env.get('SENDGRID_API_KEY');
    const emailFrom = Deno.env.get('EMAIL_FROM') || 'noreply@sayarat.com';
    
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    if (!sendgridApiKey) {
      return new Response(
        JSON.stringify({ error: 'SendGrid API key not configured' }),
        { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
      );
    }

    // Get all saved searches with email digest enabled
    // Only send if last digest was more than 6 days ago (weekly)
    const sixDaysAgo = new Date();
    sixDaysAgo.setDate(sixDaysAgo.getDate() - 6);

    const { data: savedSearches, error: searchesError } = await supabase
      .from('saved_searches')
      .select('*')
      .eq('email_digest_enabled', true)
      .or(`last_digest_sent_at.is.null,last_digest_sent_at.lt.${sixDaysAgo.toISOString()}`);

    if (searchesError) {
      throw searchesError;
    }

    if (!savedSearches || savedSearches.length === 0) {
      return new Response(
        JSON.stringify({ success: true, message: 'No digests to send', sent_count: 0 }),
        { headers: { 'Content-Type': 'application/json', ...corsHeaders } }
      );
    }

    // Get all active vehicles created in the last 7 days
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const { data: recentVehicles, error: vehiclesError } = await supabase
      .from('vehicles')
      .select('*')
      .eq('status', 'active')
      .or('is_deleted.is.null,is_deleted.eq.false')
      .gte('created_at', sevenDaysAgo.toISOString())
      .order('created_at', { ascending: false });

    if (vehiclesError) {
      throw vehiclesError;
    }

    // Group saved searches by user
    const userSearches = new Map<string, SavedSearch[]>();
    for (const search of savedSearches) {
      const existing = userSearches.get(search.user_id) || [];
      existing.push(search);
      userSearches.set(search.user_id, existing);
    }

    // Get user details
    const userIds = Array.from(userSearches.keys());
    const { data: users, error: usersError } = await supabase
      .from('users')
      .select('id, email, full_name')
      .in('id', userIds);

    if (usersError) {
      throw usersError;
    }

    const usersMap = new Map(users?.map(u => [u.id, u]) || []);

    let sentCount = 0;
    const errors: string[] = [];

    // Send digest email to each user
    for (const [userId, searches] of userSearches) {
      const user = usersMap.get(userId);
      if (!user || !user.email) continue;

      // Find matching vehicles for each saved search
      const searchMatches: { search: SavedSearch; vehicles: Vehicle[] }[] = [];
      
      for (const search of searches) {
        const matchingVehicles = (recentVehicles || []).filter(vehicle => 
          vehicleMatchesSearch(vehicle, search)
        ).slice(0, 5); // Limit to 5 vehicles per search
        
        if (matchingVehicles.length > 0) {
          searchMatches.push({ search, vehicles: matchingVehicles });
        }
      }

      // Skip if no matches found
      if (searchMatches.length === 0) {
        // Update last_digest_sent_at even if no matches (to prevent repeated checks)
        for (const search of searches) {
          await supabase
            .from('saved_searches')
            .update({ last_digest_sent_at: new Date().toISOString() })
            .eq('id', search.id);
        }
        continue;
      }

      // Generate email HTML
      const emailHtml = generateDigestEmail(user, searchMatches, supabaseUrl);

      // Send email via SendGrid
      try {
        const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${sendgridApiKey}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            personalizations: [{
              to: [{ email: user.email, name: user.full_name || undefined }],
            }],
            from: { email: emailFrom, name: 'Sayarat' },
            subject: `Your Weekly Vehicle Digest - ${searchMatches.reduce((sum, m) => sum + m.vehicles.length, 0)} New Matches`,
            content: [{
              type: 'text/html',
              value: emailHtml,
            }],
          }),
        });

        if (response.ok) {
          sentCount++;
          
          // Update last_digest_sent_at for all searches
          for (const search of searches) {
            await supabase
              .from('saved_searches')
              .update({ last_digest_sent_at: new Date().toISOString() })
              .eq('id', search.id);
          }
        } else {
          const errorText = await response.text();
          errors.push(`Failed to send to ${user.email}: ${errorText}`);
        }
      } catch (emailError) {
        errors.push(`Error sending to ${user.email}: ${emailError.message}`);
      }
    }

    return new Response(
      JSON.stringify({ 
        success: true, 
        sent_count: sentCount,
        total_users: userSearches.size,
        errors: errors.length > 0 ? errors : undefined,
      }),
      { headers: { 'Content-Type': 'application/json', ...corsHeaders } }
    );

  } catch (error) {
    console.error('Error sending saved search digest:', error);
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
    );
  }
});

function generateDigestEmail(
  user: User, 
  searchMatches: { search: SavedSearch; vehicles: Vehicle[] }[],
  baseUrl: string
): string {
  const appUrl = 'https://sayarat.com'; // Replace with actual app URL
  
  const vehicleCards = searchMatches.map(({ search, vehicles }) => {
    const vehicleHtml = vehicles.map(vehicle => {
      const imageUrl = vehicle.images?.[0] || 'https://via.placeholder.com/300x200?text=No+Image';
      const formattedPrice = new Intl.NumberFormat('en-US', { 
        style: 'currency', 
        currency: 'USD',
        maximumFractionDigits: 0,
      }).format(vehicle.price);
      
      return `
        <div style="display: inline-block; width: 200px; margin: 10px; vertical-align: top; background: #1A1A1A; border-radius: 12px; overflow: hidden;">
          <a href="${appUrl}/vehicle/${vehicle.id}" style="text-decoration: none; color: inherit;">
            <img src="${imageUrl}" alt="${vehicle.title}" style="width: 100%; height: 130px; object-fit: cover;" />
            <div style="padding: 12px;">
              <h4 style="margin: 0 0 4px 0; color: #fff; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${vehicle.year} ${vehicle.make} ${vehicle.model}
              </h4>
              <p style="margin: 0; color: #C0A062; font-size: 16px; font-weight: bold;">
                ${formattedPrice}
              </p>
              <p style="margin: 4px 0 0 0; color: #888; font-size: 12px;">
                ${vehicle.location || 'Location N/A'}
              </p>
            </div>
          </a>
        </div>
      `;
    }).join('');

    return `
      <div style="margin-bottom: 30px;">
        <h3 style="color: #C0A062; margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 10px;">
          ${search.name} (${vehicles.length} new)
        </h3>
        <div style="text-align: center;">
          ${vehicleHtml}
        </div>
      </div>
    `;
  }).join('');

  const totalMatches = searchMatches.reduce((sum, m) => sum + m.vehicles.length, 0);

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body style="margin: 0; padding: 0; background-color: #0D0D0D; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
      <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <!-- Header -->
        <div style="text-align: center; padding: 30px 0; border-bottom: 1px solid #333;">
          <h1 style="color: #C0A062; margin: 0; font-size: 28px;">Sayarat</h1>
          <p style="color: #888; margin: 10px 0 0 0;">Your Weekly Vehicle Digest</p>
        </div>

        <!-- Greeting -->
        <div style="padding: 30px 0;">
          <h2 style="color: #fff; margin: 0 0 10px 0;">
            Hi ${user.full_name || 'there'}!
          </h2>
          <p style="color: #aaa; margin: 0; line-height: 1.6;">
            We found <strong style="color: #C0A062;">${totalMatches} new vehicles</strong> matching your saved searches this week. 
            Check them out below!
          </p>
        </div>

        <!-- Vehicle Matches -->
        ${vehicleCards}

        <!-- CTA Button -->
        <div style="text-align: center; padding: 20px 0;">
          <a href="${appUrl}/saved-searches" 
             style="display: inline-block; background: #C0A062; color: #000; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 16px;">
            View All Saved Searches
          </a>
        </div>

        <!-- Footer -->
        <div style="border-top: 1px solid #333; padding-top: 20px; margin-top: 30px; text-align: center;">
          <p style="color: #666; font-size: 12px; margin: 0 0 10px 0;">
            You're receiving this email because you enabled weekly digest for your saved searches.
          </p>
          <p style="color: #666; font-size: 12px; margin: 0;">
            <a href="${appUrl}/saved-searches" style="color: #C0A062;">Manage your saved searches</a> | 
            <a href="${appUrl}/notification-settings" style="color: #C0A062;">Unsubscribe</a>
          </p>
          <p style="color: #444; font-size: 11px; margin: 20px 0 0 0;">
            Â© ${new Date().getFullYear()} Sayarat. All rights reserved.
          </p>
        </div>
      </div>
    </body>
    </html>
  `;
}

function vehicleMatchesSearch(vehicle: Vehicle, search: SavedSearch): boolean {
  const filters = search.filters || {};
  
  // Check search query
  if (search.search_query) {
    const query = search.search_query.toLowerCase();
    const searchableText = `${vehicle.title} ${vehicle.make} ${vehicle.model}`.toLowerCase();
    if (!searchableText.includes(query)) {
      return false;
    }
  }

  // Check make filter
  if (filters.make && filters.make !== 'All Makes') {
    if (vehicle.make !== filters.make) return false;
  }

  // Check body type filter
  if (filters.bodyType && filters.bodyType !== 'All Types') {
    if (vehicle.body_type !== filters.bodyType) return false;
  }

  // Check location filter
  if (filters.location && filters.location !== 'All Locations') {
    if (vehicle.location !== filters.location) return false;
  }

  // Check condition filter
  if (filters.condition && filters.condition !== 'All') {
    if (vehicle.condition !== filters.condition) return false;
  }

  // Check transmission filter
  if (filters.transmission && filters.transmission !== 'All') {
    if (vehicle.transmission !== filters.transmission) return false;
  }

  // Check fuel type filter
  if (filters.fuelType && filters.fuelType !== 'All') {
    if (vehicle.fuel_type !== filters.fuelType) return false;
  }

  // Check color filter
  if (filters.color && filters.color !== 'All Colors') {
    const vehicleColor = vehicle.specs?.color?.toLowerCase() || '';
    const filterColor = filters.color.toLowerCase();
    if (!vehicleColor.includes(filterColor)) {
      return false;
    }
  }

  // Check min price filter
  if (filters.minPrice) {
    const minPrice = parseInt(filters.minPrice);
    if (!isNaN(minPrice) && vehicle.price < minPrice) {
      return false;
    }
  }

  // Check max price filter
  if (filters.maxPrice) {
    const maxPrice = parseInt(filters.maxPrice);
    if (!isNaN(maxPrice) && vehicle.price > maxPrice) {
      return false;
    }
  }

  // Check min year filter
  if (filters.minYear && filters.minYear !== 'Any') {
    const minYear = parseInt(filters.minYear);
    if (!isNaN(minYear) && vehicle.year < minYear) {
      return false;
    }
  }

  // Check max year filter
  if (filters.maxYear && filters.maxYear !== 'Any') {
    const maxYear = parseInt(filters.maxYear);
    if (!isNaN(maxYear) && vehicle.year > maxYear) {
      return false;
    }
  }

  // Check legacy price range filter
  if (filters.priceRange && filters.priceRange !== 'Any Price' && !filters.minPrice && !filters.maxPrice) {
    const price = vehicle.price;
    switch (filters.priceRange) {
      case 'Under $30,000':
        if (price >= 30000) return false;
        break;
      case '$30,000 - $50,000':
        if (price < 30000 || price > 50000) return false;
        break;
      case '$50,000 - $80,000':
        if (price < 50000 || price > 80000) return false;
        break;
      case '$80,000 - $120,000':
        if (price < 80000 || price > 120000) return false;
        break;
      case '$120,000 - $200,000':
        if (price < 120000 || price > 200000) return false;
        break;
      case 'Over $200,000':
        if (price <= 200000) return false;
        break;
    }
  }

  return true;
}
